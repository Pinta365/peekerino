name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Determine version
        id: version
        shell: pwsh
        run: |
          $ref = "${{ github.ref }}"
          if ($ref -match '^refs/tags/v(.+)$') {
            $version = $matches[1]
          } else {
            $version = "snapshot-${{ github.run_number }}"
          }

          if ($version -match '^([0-9]+)\.([0-9]+)\.([0-9]+)') {
            $assemblyVersion = "{0}.{1}.{2}.0" -f $matches[1], $matches[2], $matches[3]
          } else {
            $assemblyVersion = "0.0.0.0"
          }

          Write-Host "Using version $version"
          Write-Host "Using assembly version $assemblyVersion"

          "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ASSEMBLY_VERSION=$assemblyVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Publish win-x64
        run: |
          dotnet publish peekerino.csproj `
            -c Release `
            -r win-x64 `
            /p:DebugType=None `
            /p:DebugSymbols=false `
            /p:Version=$env:VERSION `
            /p:AssemblyVersion=$env:ASSEMBLY_VERSION `
            /p:FileVersion=$env:ASSEMBLY_VERSION `
            /p:AssemblyInformationalVersion=$env:VERSION `
            /p:PublishSingleFile=true `
            /p:IncludeAllContentForSelfExtract=true `
            /p:EnableCompressionInSingleFile=true `
            --self-contained true

      - name: Publish win-arm64
        run: |
          dotnet publish peekerino.csproj `
            -c Release `
            -r win-arm64 `
            /p:DebugType=None `
            /p:DebugSymbols=false `
            /p:Version=$env:VERSION `
            /p:AssemblyVersion=$env:ASSEMBLY_VERSION `
            /p:FileVersion=$env:ASSEMBLY_VERSION `
            /p:AssemblyInformationalVersion=$env:VERSION `
            /p:PublishSingleFile=true `
            /p:IncludeAllContentForSelfExtract=true `
            /p:EnableCompressionInSingleFile=true `
            --self-contained true

      - name: Prepare artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path artifacts -Force | Out-Null

          $version = $env:VERSION

          $paths = @(
            @{ Runtime = "win-x64"; PublishPath = "bin/Release/net9.0-windows/win-x64/publish" },
            @{ Runtime = "win-arm64"; PublishPath = "bin/Release/net9.0-windows/win-arm64/publish" }
          )

          foreach ($entry in $paths) {
            $runtime = $entry.Runtime
            $publishPath = Join-Path $PWD $entry.PublishPath

            if (-not (Test-Path $publishPath)) {
              throw "Publish path not found: $publishPath"
            }

            $zipName = "Peekerino-$version-$runtime.zip"
            $zipPath = Join-Path $PWD "artifacts/$zipName"

            if (Test-Path $zipPath) { Remove-Item $zipPath -Force }

            Compress-Archive -Path (Join-Path $publishPath '*') -DestinationPath $zipPath
          }

      - name: Generate release notes
        if: startsWith(github.ref, 'refs/tags/')
        shell: pwsh
        run: |
          $currentTag = "${{ github.ref_name }}"
          $notesPath = Join-Path $PWD "artifacts/release-notes.md"

          $tagList = git tag --sort=-creatordate
          $previousTag = $null
          foreach ($tag in $tagList) {
            if ($tag -eq $currentTag) { continue }
            $previousTag = $tag
            break
          }

          $description = "A lightweight Windows tray app for peeking at file contents with a single hotkey."
          $readmePath = Join-Path $PWD "README.md"
          if (Test-Path $readmePath) {
            $readmeLines = Get-Content $readmePath
            $paragraphLines = New-Object System.Collections.Generic.List[string]
            $collecting = $false

            foreach ($line in $readmeLines) {
              $trimmed = $line.Trim()
              if (-not $collecting) {
                if ([string]::IsNullOrWhiteSpace($trimmed)) { continue }
                if ($trimmed.StartsWith("#")) { continue }
                $paragraphLines.Add($trimmed)
                $collecting = $true
                continue
              }

              if ([string]::IsNullOrWhiteSpace($trimmed)) { break }
              $paragraphLines.Add($trimmed)
            }

            if ($paragraphLines.Count -gt 0) {
              $description = [string]::Join(" ", $paragraphLines)
            }
          }

          if ($previousTag) {
            $range = "$previousTag..$currentTag"
            $changes = git log $range --no-merges '--pretty=format:- %h %s'
            $changesHeading = "### Changes since $previousTag"
          } else {
            $changes = git log $currentTag --no-merges '--pretty=format:- %h %s'
            $changesHeading = "### Changes"
          }

          if (-not $changes) {
            $changes = "- No commits found."
          }

          $lines = @(
            "## Peekerino $currentTag",
            "",
            $description,
            "",
            "### ðŸ“¦ Downloads",
            "",
            "- **Peekerino-$currentTag-win-x64.zip** - Self-contained build for 64-bit Windows",
            "- **Peekerino-$currentTag-win-arm64.zip** - Self-contained build for ARM64 Windows",
            "",
            'Each package contains the single-file executable and config (`appsettings.json`).',
            "",
            $changesHeading,
            ""
          )

          $lines += $changes

          Set-Content -Path $notesPath -Value $lines -Encoding UTF8

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Peekerino-Release
          path: artifacts/*.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.zip
          body_path: artifacts/release-notes.md

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
